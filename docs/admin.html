<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skilling ‚Äî Admin Panel</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    display: flex;
    justify-content: center;
    padding: 32px 16px;
    min-height: 100vh;
  }
  .wrap { width: 600px; max-width: 100%; }
  h1 { font-size: 20px; margin-bottom: 20px; color: #ffd700; }
  h2 { font-size: 16px; margin: 24px 0 12px; color: #ffd700; }
  label { display: block; font-size: 13px; margin-bottom: 4px; color: #aaa; }
  input, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #334;
    border-radius: 6px;
    background: #0f3460;
    color: #fff;
    font-size: 14px;
    margin-bottom: 12px;
    outline: none;
  }
  input:focus, textarea:focus { border-color: #ffd700; }
  textarea { resize: vertical; min-height: 60px; }
  .row { display: flex; gap: 8px; margin-bottom: 12px; }
  .row input { margin-bottom: 0; }
  .row label { flex: 1; }
  button {
    padding: 10px 16px;
    background: #ffd700;
    color: #1a1a2e;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover { background: #ffed4a; }
  button:disabled { background: #555; color: #888; cursor: not-allowed; }
  .btn-row { display: flex; gap: 8px; }
  .btn-secondary { background: #334; color: #e0e0e0; }
  .btn-secondary:hover { background: #445; }
  .status { margin-top: 8px; font-size: 13px; text-align: center; min-height: 20px; }
  .status.ok { color: #6ed998; }
  .status.err { color: #ff6b6b; }
  .conn { font-size: 12px; color: #888; margin-bottom: 12px; }
  .conn.connected { color: #6ed998; }

  /* Player list */
  .player-count { font-size: 13px; color: #aaa; margin-bottom: 8px; }
  .player-list { display: flex; flex-direction: column; gap: 6px; }
  .player-card {
    background: #16213e;
    border: 1px solid #334;
    border-radius: 8px;
    padding: 10px 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .player-swatch {
    width: 14px; height: 14px;
    border-radius: 50%;
    margin-top: 3px;
    flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .player-info { flex: 1; min-width: 0; }
  .player-name { font-weight: bold; font-size: 14px; color: #fff; }
  .player-room { font-size: 11px; color: #888; margin-left: 6px; }
  .player-meta { font-size: 12px; color: #aaa; margin-top: 3px; }
  .player-skills {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px 10px;
    font-size: 11px;
    color: #ccc;
    margin-top: 4px;
  }
  .player-activity { font-size: 11px; color: #6ed998; margin-top: 3px; }
  .player-pos { font-size: 11px; color: #666; }
  .player-skin { font-size: 10px; color: #ffd700; margin-left: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
  .no-players { color: #555; font-size: 13px; padding: 12px 0; text-align: center; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin Panel</h1>

  <div class="row">
    <label>Server URL<input id="ws-url" value="wss://skilling.onrender.com" /></label>
    <label>Admin Key<input id="admin-key" type="password" /></label>
  </div>
  <div id="conn-status" class="conn">Disconnected</div>

  <h2>Broadcast</h2>
  <textarea id="msg" placeholder="Message to all players..."></textarea>
  <div class="btn-row">
    <button id="send-btn" disabled>Send Broadcast</button>
    <button id="refresh-btn" class="btn-secondary" disabled>Refresh Players</button>
  </div>
  <div id="status" class="status"></div>

  <h2>Online Players</h2>
  <div id="player-count" class="player-count">‚Äî</div>
  <div id="player-list" class="player-list">
    <div class="no-players">Connect to see players</div>
  </div>
</div>

<script>
const wsInput = document.getElementById("ws-url");
const keyInput = document.getElementById("admin-key");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send-btn");
const refreshBtn = document.getElementById("refresh-btn");
const statusEl = document.getElementById("status");
const connEl = document.getElementById("conn-status");
const playerCountEl = document.getElementById("player-count");
const playerListEl = document.getElementById("player-list");

let ws = null;
let refreshInterval = null;

function connect() {
  if (ws) { ws.close(); ws = null; }
  clearInterval(refreshInterval);
  const url = wsInput.value.trim();
  if (!url) return;
  connEl.textContent = "Connecting...";
  connEl.className = "conn";
  ws = new WebSocket(url);
  ws.onopen = () => {
    connEl.textContent = "Connected";
    connEl.className = "conn connected";
    sendBtn.disabled = false;
    refreshBtn.disabled = false;
    ws.send(JSON.stringify({ type: "hello", room: "main", name: "Admin", color: "#ffd700" }));
  };
  ws.onmessage = (e) => {
    let msg;
    try { msg = JSON.parse(e.data); } catch { return; }
    if (msg.type === "admin_players") renderPlayers(msg.players || []);
  };
  ws.onclose = () => {
    connEl.textContent = "Disconnected";
    connEl.className = "conn";
    sendBtn.disabled = true;
    refreshBtn.disabled = true;
    clearInterval(refreshInterval);
  };
  ws.onerror = () => {
    connEl.textContent = "Connection error";
    connEl.className = "conn";
  };
}

function requestPlayers() {
  const key = keyInput.value.trim();
  if (!key) { playerCountEl.textContent = "Enter admin key first"; return; }
  if (!ws || ws.readyState !== WebSocket.OPEN) { playerCountEl.textContent = "Not connected"; return; }
  ws.send(JSON.stringify({ type: "admin_players", key }));
  playerCountEl.textContent = "Requesting...";
}

function startAutoRefresh() {
  clearInterval(refreshInterval);
  requestPlayers();
  refreshInterval = setInterval(requestPlayers, 5000);
}

/* start polling once key is entered */
keyInput.addEventListener("input", () => {
  if (keyInput.value.trim() && ws && ws.readyState === WebSocket.OPEN) {
    startAutoRefresh();
  }
});

const PATTERN_CSS = {
  fire: "linear-gradient(135deg, #ff4500, #ff8c00, #ffd700)",
  ice: "linear-gradient(135deg, #88cfff, #d0eaff, #b0d4f1)",
  galaxy: "linear-gradient(135deg, #1a0533, #6b2fa0, #ff6ec7)",
  toxic: "linear-gradient(135deg, #39ff14, #7fff00, #2e8b57)",
  lava: "linear-gradient(135deg, #ff2200, #ff6600, #331100)",
  ocean: "linear-gradient(135deg, #006994, #00b4d8, #90e0ef)",
  rainbow: "linear-gradient(135deg, red, orange, yellow, green, blue, violet)",
  gold: "linear-gradient(135deg, #ffd700, #ffed4a, #b8860b)",
  stained: "conic-gradient(#d91e30, #2690e8, #f2c010, #35c759, #b32dc9, #fb7310, #1accc8, #e64099)",
};

function swatchStyle(color) {
  if (PATTERN_CSS[color]) return `background:${PATTERN_CSS[color]}`;
  return `background:${color || '#58df78'}`;
}

function getActivity(state) {
  if (!state) return "Idle";
  if (state.attacking) return `‚öîÔ∏è Fighting (${state.combatStyle || "melee"})`;
  if (state.gathering) return `‚õèÔ∏è Skilling (${state.tool || "?"})`;
  if (state.crouching) return "ü¶Ü Crouching";
  if (state.jumping) return "ü¶ò Jumping";
  if (state.moving) return "üö∂ Walking";
  return "üí§ Idle";
}

function getEquip(state) {
  if (!state) return "";
  const toolIcons = { fishing: "üé£", axe: "ü™ì", pickaxe: "‚õèÔ∏è", sword: "üó°Ô∏è", bow: "üèπ", staff: "üîÆ" };
  const tool = state.tool || "fishing";
  return `${toolIcons[tool] || "üîß"} ${tool}`;
}

function renderPlayers(players) {
  // filter out the Admin connection itself
  const real = players.filter(p => p.name !== "Admin");
  playerCountEl.textContent = `${real.length} player${real.length !== 1 ? "s" : ""} online`;
  if (real.length === 0) {
    playerListEl.innerHTML = '<div class="no-players">No players online</div>';
    return;
  }
  playerListEl.innerHTML = "";
  for (const p of real) {
    const s = p.state || {};
    const sk = s.skills || {};
    const card = document.createElement("div");
    card.className = "player-card";
    const hasCampfire = s.campfireX != null && s.campfireZ != null;
    card.innerHTML = `
      <div class="player-swatch" style="${swatchStyle(p.color)}"></div>
      <div class="player-info">
        <div>
          <span class="player-name">${esc(p.name)}</span>
          <span class="player-room">${esc(p.room)}</span>
          <span class="player-skin">${PATTERN_CSS[p.color] ? p.color : ''}</span>
        </div>
        <div class="player-meta">Total Lv ${s.totalLevel || 6} ¬∑ ${getEquip(s)}</div>
        <div class="player-skills">
          <span>üêü Fish ${sk.fishing || 1}</span>
          <span>ü™® Mine ${sk.mining || 1}</span>
          <span>ü™µ WC ${sk.woodcutting || 1}</span>
          <span>üó° Melee ${sk.melee || 1}</span>
          <span>üèπ Range ${sk.bow || 1}</span>
          <span>üî• Mage ${sk.mage || 1}</span>
          <span>üç≥ Cook ${sk.cooking || 1}</span>
        </div>
        <div class="player-activity">${getActivity(s)}${hasCampfire ? ' ¬∑ üî• Campfire' : ''}</div>
        <div class="player-pos">Pos: (${(s.x||0).toFixed(0)}, ${(s.z||0).toFixed(0)})${s.y ? ` Y:${s.y.toFixed(1)}` : ''}</div>
      </div>`;
    playerListEl.appendChild(card);
  }
}

function esc(str) {
  const d = document.createElement("div");
  d.textContent = str || "";
  return d.innerHTML;
}

wsInput.addEventListener("change", connect);
setTimeout(connect, 300);

refreshBtn.addEventListener("click", requestPlayers);

sendBtn.addEventListener("click", () => {
  const text = msgInput.value.trim();
  const key = keyInput.value.trim();
  if (!text || !key || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: "admin_broadcast", key, text }));
  statusEl.textContent = "Sent!";
  statusEl.className = "status ok";
  msgInput.value = "";
  setTimeout(() => { statusEl.textContent = ""; }, 3000);
});
</script>
</body>
</html>
